(()=>{var s=class{constructor({host:t="http://localhost:9527",width:e=64,height:i=64,options:a={}}={}){this._host=t,this._updateDelay=0,this._context=new OffscreenCanvas(e,i).getContext("2d",{willReadFrequently:!0,...a}),this._animationFrameCanvas=new OffscreenCanvas(e,i),this._animationFrames=[];let{fill:n,stroke:o,fillRect:r,strokeRect:c,fillText:d,strokeText:m,drawImage:l,clearRect:p}=this._context;[n,o,r,c,d,m,l,p].forEach(h=>{this._context[h.name]=(...u)=>{let g=h.apply(this._context,u);return this.forceUpdate(),g}})}get width(){return this._context.canvas.width}get height(){return this._context.canvas.height}get context(){return this._context}get canvas(){return this._context.canvas}setUpdateLatency(t=0){this._updateDelay=t}forceUpdate(){return this._updatePromise||(this._updatePromise=new Promise(t=>{this._updateDelay<=0&&typeof requestAnimationFrame=="function"?requestAnimationFrame(()=>{this._updatePromise=null,this.update(),t()}):setTimeout(()=>{this._updatePromise=null,this.update(),t()},this._updateDelay)})),this._updatePromise}async send(t){let e=await(await fetch(`${this._host}/send`,{method:"POST",headers:{Accept:"application/json"},body:JSON.stringify(t)})).json();if(typeof CustomEvent=="function"){let i=new CustomEvent("devicestatechange",{detail:{device:this,payload:t,response:e}});window.dispatchEvent(i)}return e}async update(){let t=this.getFrameData(),e={Command:"Draw/SendHttpGif",PicWidth:this.width,PicNum:1,PicID:Math.random().toString(16).slice(2),PicOffset:0,PicData:t,PicSpeed:1};await this.send(e)}clear(){this._context.clearRect(0,0,this.width,this.height)}setUpdateLatency(t=0){this._updateDelay=t}getFrameData(t=this._context){let e=t.getImageData(0,0,this.width,this.height).data,i=[];for(let a=0;a<this.width*this.height;a++){let n=a*4;i.push(String.fromCharCode(e[n]),String.fromCharCode(e[n+1]),String.fromCharCode(e[n+2]))}return btoa(i.join(""))}appendAnimationFrame(t,e=16){let i=this._animationFrameCanvas.getContext("2d",{willReadFrequently:!0});i.clearRect(0,0,this.width,this.height),i.drawImage(t,0,0,this.width,this.height);let a=this.getFrameData(i);this._animationFrames.push({picData:a,delay:e})}async clearAnimationFrames(){this._animationFrames.length=0}async playAnimation(t=this._animationFrames){if(t.length<=0){console.warn("no animation frames to update");return}t.length>60&&(console.warn("too many frames to update, max 60 frames"),t.length=60);let e={Command:"Draw/SendHttpGif",PicWidth:this.width,PicNum:t.length,PicID:Math.random().toString(16).slice(2)};for(let i=0;i<t.length;i++){e.PicOffset=i;let{picData:a,delay:n}=t[i];if(e.PicData=a,e.PicSpeed=n,await this.send(e),typeof CustomEvent=="function"){let o=new CustomEvent("deviceuploadprogress",{detail:{device:this,progress:(i+1)/t.length}});window.dispatchEvent(o)}}}};window.PixooDoodle=s;})();
